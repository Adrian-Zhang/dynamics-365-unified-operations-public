---
# required metadata

title: Allow row version change tracking for data entities 
description: This article explains how to allow row version change tracking for data entities and tabels for Finance and Operations apps.
author: peakerbl
ms.date: 09/28/2022
ms.topic: article
ms.prod:
ms.technology: 

# optional metadata

# ms.search.form:
audience: Developer, IT Pro
# ms.devlang: 
ms.reviewer: 
# ms.tgt_pltfrm: 
# ms.custom: NotInToc
ms.search.region: Global
# ms.search.industry:
ms.author: peakerbl
ms.search.validFrom: 2022-10-10
ms.dyn365.ops.version: 10.0.31
---

# Allow Row version change tracking for Data entities

[!include[banner](../includes/banner.md)]

## SQL Row version change tracking

A new change tracking option has been added to Finance and Operations to enable incremental synchronization of data using the Dataverse. The new change tracking is a prerequisute for several features such as Data archival, Synapse integration, Mobile offline and Relevance search. The new change tracking is enabled for Public preview from 10.0.31. The goal is to over time unify all existing Fainance and Operations data synchronization frameworks into one that is based on Dataverse synchronization services. This topic covers what is required for Track chnages to be selected in PowerApps for Finance and Operations Virtual tables. To actually enable Track changes for a Virtual table, see   

## Source tables must have a SQL row version column

A new column named **SQL row version** must be added to all tables used as sources for a data entity that allow to use Row version change tracking. The **SQL row version** column performs version stamping of table rows. SQL server maintains a database level counter that is incremented for each insert or update operation. Every time a row with a row version column is modified or inserted, the incremented database row version counter is inserted in the row version column. The **SQL row version** column has the following characteristics.

- SQL Data type is rowversion.
- Int64 number are stored by SQL server as binary(8) in big-endian format.
- SQL read-only column whose value is auto generated by SQL server.
- Only one row version column is allowed per table.
- Row version value is unique across tables in a database.

Changes to a table row can be detected by comparing the current value in row version column with the previous value. Also, it now becomes easy to determine all rows that have changed since a particular point in time by querying for rows whose row version is greater than a particular valu


## Allow Row version change tracking on tables

A new property, **Allow Row Version Change Tracking**, of type **No/Yes** has been added to the **AXtable** metadata. All table(s) used as data source for a data entity,  must have the property set to **Yes** to allow row version change tracking for the entity. 

When this metadata property is set to **Yes** for a table in, the AOT automatically adds a new SQL row version field to the table named **SysRowVersionNumber**. This field cannot be manually deleted or modified in AOT. Following are the properties of **SysRowVersionNumber field**. 

- Extended data type: **SysRowVersionNumber**
- AllowEdit = No
- AllowEditOnCreate = No
- SysSharingType = Never
- Null = Yes

Following are the various validations associated with the field. These validations exist while editing in AOT. These validations are also performed during build time by metadata validator.

- Field name SysRowVersionNumber cannot be re-used by any other OOB field or custom field.
- Only table field with field name SysRowVersionNumber can have SysRowVersionNumber edt.
- SysRowVersionNumber field can only be added to the base table in the table hierarchy.
- SysRowVersionNumber field cannot be added to temp table or in-memory table.
- SysRowVersionNumber field with correct property values is present on the table when Allow Row Version Change Tracking property of the table is set to Yes and vice versa.
- SysRowVersionNumber field cannot be added to the table with TableGroup == TableGroup.Staging. Also the StagingTableGenerator skips adding SysRowVersionNumber column to the DIXF staging table. Currently SysRowVersionNumber is not in scope for staging tables.

**Adding SQL row version column to SQL table**

DB Sync creates a column of data type SQL row version when the extended data type of an AxEdtInt64 field is set to SysRowVersionNumber. Normally adding a row version column to a large table can take a significant amount of time because SQL server tries to populate row version values to existing records. The SQL server team has provided a solution for Finance and Operations apps to not populate row version values to existing records. The value will be NULL for rows that existed before adding SQL row version field. This will not impact data synchronization since full sync is always performed first. Any incremental changes will have SQL row version populated. 

**Index to SQL row version column**

An **OPTMIZIE_FOR_SEQUENTIAL_KEY** index hint is automatically added to the SQL row version index first when it is required, i.e. only when **Track changes** is selected for a Finance and Operations Virtual table in Dataverse.

**Preventing row version value update in DML**

The SQL row version column is read only in SQL. Hence validation has been added in X++ validator to generate a compilation error if SysRowVersionNumber field is specified in X++ insert or update statements. Also, Defensive fixes have been added in both managed and native Kernel to make sure SysRowVersionNumber field does not get added to kernel generated DML statements. This defensive fix will not guard against any direct raw SQL executed by X++ code using ADO.NET command object or X++ raw SQL statement object.

## Allow Row version change tracking on Data entities

A new metadata property **Allow Row Version Change Tracking** of type **No/Yes** has been added to the **AxDataEntityView** metadata. Not all exisiting data entities are configured to support Row version chnage tracking, this is mainly due to the complexity of the entity configuration. Examples of characteristics that prevents an entity from being used for Row version change tracking:

- Non-table data source(s).
- Tables used as source have **Allow row version change tracking** set to No.
- One-to-many cardinality. One-to-many cardinality would produce duplicate primary key values for Dataverse F&O virtual entity. This is because currently GUID constructed from RecId of primary table is used as a primary key for Dataverse F&O virtual entity records.
- Group By conditions
- Range or date filters 
- Custom change tracking query
- Joins other than left outer joins. Non-left outer joins and filter conditions will cause records to disappear from the view, which cannot be change tracked with SQL row version change tracking mechanism.
- Type is Composite.
- Number of data source(s) exceeds 10. This limitation is enforced from performance standpoint.

Build time metadata validator has been added to validate AxDataEntityView with Allow Row Version Change Tracking = Yes, to make sure data entity pass the above rules. If the rules fail metadata validator will report error. The **SysRowVersionNumber** column of the primary table is added to the data entity view when Allow Row Version Change Tracking is set to Yes for an Entity.

**Tracking deletes from primary data source**

When record is deleted from primary data source, the corresponding row gets removed from the data entity view. For the Dataverse F&O VE this is surfaced as a delete change. Data entity row deletions are change tracked using a delete trigger on the primary data source table. The trigger stores TableId and RecId of the deleted row in a delete tracking tbale **AifChangeTrackingDeletedObject**.

**Tracking deletes from related data source**

When a related data source record is deleted, the column values in the view row corresponding to that related data source will become null. This is a change to a view row and needs to be change tracked. Deletes from related data source(s) are change tracked using a delete trigger on the table. The delete trigger performs dummy update of the joined source data source record. 

There is a system batch job **Delete tracking history clean-up** that cleans up records in the **AifChangeTrackingDeletedObject** table that has exceeded the retention period. Records is deleted in batches until the timeout criteria is reached. This system job is singleton. The job runs every day at 1 AM. The recurrence and frequency of the job is configurable in **System Administration>Batch Jobs**. The retention period, delete batch size and timeout is configurable using **SysGlobalConfiguration settings**.

##Retrive row version entity changes##

For details for how to use the **RetrieveEntityChanges** API, see TBA
 
[!INCLUDE[footer-include](../../../includes/footer-banner.md)]
